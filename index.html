<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans p-6 bg-gray-50 h-screen overflow-hidden">
  <!-- <h2 class="text-2xl font-bold mb-6 text-center">Expense Tracker</h2> -->

  <!-- Container: two columns -->
  <div class="flex gap-8 items-stretch h-full">

    <!-- LEFT: Form + Chart + Categories -->
    <div class="w-1/3 space-y-6 ">

      <!-- Form -->
      <form id="transactionForm" class="flex flex-col gap-3 bg-white p-4 shadow rounded">
        <input type="date" id="date" required class="p-2 border rounded">
        <input type="number" id="amount" placeholder="金額" step="0.01" required class="p-2 border rounded">
        <input type="text" id="description" placeholder="描述 (例如 Starbucks)" required class="p-2 border rounded">
        <button type="submit" class="bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
          新增交易
        </button>
      </form>

      <!-- Pie Chart -->
      <div class="bg-white p-4 shadow rounded">
        <h3 class="text-lg font-semibold mb-2">消費分布圖</h3>
        <canvas id="myChart" class="max-w-sm"></canvas>
      </div>
    </div>

    <!-- RIGHT: Categories + Table -->
    <div class="w-2/3 flex flex-col space-y-6">

      <!-- Transaction Table -->
      <div class="bg-white p-4 shadow rounded flex-1 overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">交易紀錄</h3>
        <table id="transactionTable" class="w-full border border-gray-300 text-center table-fixed">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1 w-1/6">日期</th>
              <th class="border px-2 py-1 w-1/6">金額</th>
              <th class="border px-2 py-1 w-2/6">描述</th>
              <th class="border px-2 py-1 w-1/6">分類</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ========================
    // 全域變數
    // ========================
    let chart;
    const API_BASE = "http://127.0.0.1:8000";

    // ========================
    // 後端資料存取
    // ========================
    async function loadData() {
      const res = await fetch(`${API_BASE}/summary`);
      const data = await res.json();

      const labels = Object.keys(data);
      const values = Object.values(data);

      if (chart) chart.destroy();

      chart = new Chart(document.getElementById('myChart'), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: [
              '#ff6384', '#36a2eb', '#ffcd56',
              '#4bc0c0', '#9966ff', '#ff9f40'
            ]
          }]
        }
      });
    }

    async function loadTransactions() {
      const res = await fetch(`${API_BASE}/transactions`);
      const rows = await res.json();

      const tbody = document.querySelector("#transactionTable tbody");
      tbody.innerHTML = "";

      rows.forEach(tx => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${tx.date ?? ""}</td>
          <td class="border px-2 py-1">${Number(tx.amount).toFixed(2)}</td>
          <td class="border px-2 py-1">${tx.description ?? ""}</td>
          <td class="border px-2 py-1" contenteditable="true"
              onkeydown="checkEnter(event, ${tx.id}, this)">
              ${tx.category ?? ""}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateCategory(id, category) {
      await fetch(`${API_BASE}/transactions/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ category })
      });
      loadData();
    }

    async function loadCategories() {
      const res = await fetch(`${API_BASE}/categories`);
      const data = await res.json();

      const ul = document.getElementById("categoryList");
      ul.innerHTML = "";

      if (data.categories) {
        data.categories.forEach(cat => {
          const li = document.createElement("li");
          li.textContent = cat;
          ul.appendChild(li);
        });
      }
    }

    // ========================
    // UI 行為
    // ========================
    function checkEnter(event, id, element) {
      if (event.key === "Enter") {
        event.preventDefault();
        const newCategory = element.innerText.trim();
        updateCategory(id, newCategory);
        element.blur();
      }
    }

    // ========================
    // 表單事件
    // ========================
    document.getElementById('transactionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = document.getElementById('date').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const description = document.getElementById('description').value;

      await fetch(`${API_BASE}/transactions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ date, amount, description })
      });

      e.target.reset();
      loadData();
      loadTransactions();
    });

    // ========================
    // 初始化
    // ========================
    (async () => {
      await loadData();
      await loadTransactions();
      await loadCategories();
    })();
  </script>
</body>
</html>
